<Window x:Class="EstimateApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:igEditors="http://infragistics.com/Editors"
        xmlns:behaviors="clr-namespace:EstimateApp.Behaviors"
        xmlns:local="clr-namespace:EstimateApp"
        mc:Ignorable="d"
        Title="見積登録システム" Height="900" Width="1400"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <!-- 項目行のスタイル -->
        <Style x:Key="EstimateItemRowStyle" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="#DDDDDD"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Margin" Value="0,2"/>
            <Setter Property="Padding" Value="10"/>
            <Setter Property="CornerRadius" Value="3"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsSelected}" Value="True">
                    <Setter Property="Background" Value="#E3F2FD"/>
                    <Setter Property="BorderBrush" Value="#2196F3"/>
                    <Setter Property="BorderThickness" Value="2"/>
                </DataTrigger>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="BorderBrush" Value="#90CAF9"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- ラベルスタイル -->
        <Style x:Key="LabelStyle" TargetType="TextBlock">
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,0,5,0"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="#333333"/>
        </Style>

        <!-- 必須項目ラベルスタイル -->
        <Style x:Key="RequiredLabelStyle" TargetType="TextBlock" BasedOn="{StaticResource LabelStyle}">
            <Setter Property="Foreground" Value="#D32F2F"/>
        </Style>

        <!-- 入力コントロールの共通スタイル -->
        <Style x:Key="InputControlStyle" TargetType="Control">
            <Setter Property="Height" Value="25"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,2"/>
        </Style>

        <!-- ツールバーボタンスタイル -->
        <Style x:Key="ToolbarButtonStyle" TargetType="Button">
            <Setter Property="Height" Value="30"/>
            <Setter Property="Padding" Value="10,0"/>
            <Setter Property="Margin" Value="0,0,5,0"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="#CCCCCC"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#F5F5F5"/>
                    <Setter Property="BorderBrush" Value="#2196F3"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- メニューバー -->
        <Menu Grid.Row="0" Background="#F8F9FA" BorderBrush="#DDDDDD" BorderThickness="0,0,0,1">
            <MenuItem Header="_ファイル">
                <MenuItem Header="_新規作成" Command="{Binding ClearEstimateCommand}" InputGestureText="Ctrl+N"/>
                <Separator/>
                <MenuItem Header="_インポート..." Command="{Binding ImportEstimateCommand}"/>
                <MenuItem Header="_エクスポート..." Command="{Binding ExportEstimateCommand}"/>
                <Separator/>
                <MenuItem Header="_印刷プレビュー..." Command="{Binding PrintPreviewCommand}" InputGestureText="Ctrl+P"/>
                <Separator/>
                <MenuItem Header="_終了" Click="MenuItem_Exit_Click"/>
            </MenuItem>
            <MenuItem Header="_編集">
                <MenuItem Header="_コピー" Command="{Binding CopySelectedItemCommand}" InputGestureText="Ctrl+C"/>
                <MenuItem Header="_貼り付け" Command="{Binding PasteItemCommand}" InputGestureText="Ctrl+V"/>
                <MenuItem Header="_削除" Command="{Binding DeleteSelectedItemsCommand}" InputGestureText="Del"/>
                <Separator/>
                <MenuItem Header="_複製" Command="{Binding DuplicateSelectedItemsCommand}" InputGestureText="Ctrl+D"/>
                <MenuItem Header="_全選択" Command="{Binding ToggleAllSelectionCommand}" InputGestureText="Ctrl+A"/>
            </MenuItem>
            <MenuItem Header="_ツール">
                <MenuItem Header="_バリデーション" Command="{Binding ValidateEstimateCommand}"/>
            </MenuItem>
        </Menu>

        <!-- ヘッダー部分 -->
        <Border Grid.Row="1" Background="#1976D2" Padding="15">
            <TextBlock Text="見積登録システム" FontSize="20" FontWeight="Bold" 
                       Foreground="White" HorizontalAlignment="Center"/>
        </Border>

        <!-- 見積基本情報 -->
        <Border Grid.Row="2" Background="#F5F5F5" BorderBrush="#DDDDDD" BorderThickness="0,0,0,1" Padding="15">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="10"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- 1行目 -->
                <Grid Grid.Row="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="200"/>
                        <ColumnDefinition Width="20"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="200"/>
                        <ColumnDefinition Width="20"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="200"/>
                        <ColumnDefinition Width="20"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="150"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="見積番号:" Style="{StaticResource RequiredLabelStyle}"/>
                    <igEditors:XamTextEditor Grid.Column="1" Text="{Binding EstimateNumber}" 
                                           Style="{StaticResource InputControlStyle}"/>

                    <TextBlock Grid.Column="3" Text="見積日:" Style="{StaticResource RequiredLabelStyle}"/>
                    <igEditors:XamDateTimeEditor Grid.Column="4" Value="{Binding EstimateDate}" 
                                               Style="{StaticResource InputControlStyle}"/>

                    <TextBlock Grid.Column="6" Text="顧客名:" Style="{StaticResource RequiredLabelStyle}"/>
                    <igEditors:XamTextEditor Grid.Column="7" Text="{Binding CustomerName}" 
                                           Style="{StaticResource InputControlStyle}"/>

                    <TextBlock Grid.Column="9" Text="有効期限:" Style="{StaticResource LabelStyle}"/>
                    <igEditors:XamDateTimeEditor Grid.Column="10" Value="{Binding ValidUntil}" 
                                               Style="{StaticResource InputControlStyle}"/>
                </Grid>

                <!-- 2行目（統計情報） -->
                <Grid Grid.Row="2">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="100"/>
                        <ColumnDefinition Width="20"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="100"/>
                        <ColumnDefinition Width="20"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="150"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="項目数:" Style="{StaticResource LabelStyle}"/>
                    <TextBlock Grid.Column="1" Text="{Binding EstimateItems.Count}" 
                             Style="{StaticResource LabelStyle}" FontWeight="Bold"/>

                    <TextBlock Grid.Column="3" Text="選択項目:" Style="{StaticResource LabelStyle}"/>
                    <TextBlock Grid.Column="4" Text="{Binding SelectedItemsCount}" 
                             Style="{StaticResource LabelStyle}" FontWeight="Bold"/>

                    <TextBlock Grid.Column="6" Text="ステータス:" Style="{StaticResource LabelStyle}"/>
                    <TextBlock Grid.Column="7" Text="編集中" 
                             Style="{StaticResource LabelStyle}" FontWeight="Bold" Foreground="#FF9800"/>
                </Grid>
            </Grid>
        </Border>

        <!-- 項目一覧 -->
        <ScrollViewer Grid.Row="3" VerticalScrollBarVisibility="Auto" Padding="15">
            <ItemsControl ItemsSource="{Binding EstimateItems}" 
                          Focusable="True" 
                          KeyboardNavigation.TabNavigation="Continue"
                          IsTabStop="False">
                <i:Interaction.Behaviors>
                    <behaviors:SelectionBehavior ViewModel="{Binding}" />
                </i:Interaction.Behaviors>

                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Style="{StaticResource EstimateItemRowStyle}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="20"/>
                                    <!-- インジケーター領域 -->
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- 選択インジケーター -->
                                <Border Grid.Column="0" Name="SelectionIndicator" 
                                        Background="Transparent" Cursor="Hand"
                                        VerticalAlignment="Stretch" HorizontalAlignment="Stretch">
                                    <Rectangle Width="4" VerticalAlignment="Stretch" HorizontalAlignment="Center">
                                        <Rectangle.Style>
                                            <Style TargetType="Rectangle">
                                                <Setter Property="Fill" Value="Transparent"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                        <Setter Property="Fill" Value="#2196F3"/>
                                                    </DataTrigger>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Fill" Value="#90CAF9"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Rectangle.Style>
                                    </Rectangle>
                                </Border>

                                <!-- 項目内容 -->
                                <Grid Grid.Column="1">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- 1行目: 基本情報 -->
                                    <Grid Grid.Row="0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="300"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="100"/>
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Column="0" Text="項目コード:" Style="{StaticResource RequiredLabelStyle}"/>
                                        <igEditors:XamTextEditor Grid.Column="1" Text="{Binding ItemCode}" 
                                                               Style="{StaticResource InputControlStyle}"
                                                               GotFocus="InputControl_GotFocus"/>

                                        <TextBlock Grid.Column="2" Text="項目名:" Style="{StaticResource RequiredLabelStyle}"/>
                                        <igEditors:XamTextEditor Grid.Column="3" Text="{Binding ItemName}" 
                                                               Style="{StaticResource InputControlStyle}"
                                                               GotFocus="InputControl_GotFocus"/>

                                        <TextBlock Grid.Column="4" Text="単価:" Style="{StaticResource LabelStyle}"/>
                                        <igEditors:XamNumericEditor Grid.Column="5" Value="{Binding UnitPrice, Mode=TwoWay}" 
                                                                  Style="{StaticResource InputControlStyle}"
                                                                  Format="C" SpinButtonDisplayMode="Always"
                                                                  GotFocus="InputControl_GotFocus"/>

                                        <TextBlock Grid.Column="6" Text="数量:" Style="{StaticResource LabelStyle}"/>
                                        <igEditors:XamNumericEditor Grid.Column="7" Value="{Binding Quantity, Mode=TwoWay}" 
                                                                  Style="{StaticResource InputControlStyle}"
                                                                  SpinButtonDisplayMode="Always"
                                                                  GotFocus="InputControl_GotFocus"/>

                                        <TextBlock Grid.Column="8" Text="割引:" Style="{StaticResource LabelStyle}"/>
                                        <igEditors:XamNumericEditor Grid.Column="9" Value="{Binding Discount, Mode=TwoWay}" 
                                                                  Style="{StaticResource InputControlStyle}"
                                                                  Format="C" SpinButtonDisplayMode="Always"
                                                                  GotFocus="InputControl_GotFocus"/>
                                    </Grid>

                                    <!-- 2行目: 説明と納期 -->
                                    <Grid Grid.Row="1" Margin="0,5,0,5">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="60"/>
                                            <ColumnDefinition Width="400"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="150"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="100"/>
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Column="0" Text="説明:" Style="{StaticResource LabelStyle}"/>
                                        <igEditors:XamTextEditor Grid.Column="1" Text="{Binding Description}" 
                                                               Style="{StaticResource InputControlStyle}"
                                                               GotFocus="InputControl_GotFocus"/>

                                        <TextBlock Grid.Column="2" Text="納期:" Style="{StaticResource LabelStyle}"/>
                                        <igEditors:XamDateTimeEditor Grid.Column="3" Value="{Binding DeliveryDate}" 
                                                                   Style="{StaticResource InputControlStyle}"
                                                                   GotFocus="InputControl_GotFocus"/>

                                        <TextBlock Grid.Column="4" Text="小計:" Style="{StaticResource LabelStyle}"/>
                                        <TextBlock Grid.Column="5" Text="{Binding Subtotal, StringFormat=C}" 
                                                 Style="{StaticResource LabelStyle}" FontWeight="Bold" 
                                                 Foreground="#1976D2"/>
                                    </Grid>

                                    <!-- 3行目: 備考 -->
                                    <Grid Grid.Row="2" Margin="0,0,0,5">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="60"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Column="0" Text="備考:" Style="{StaticResource LabelStyle}"/>
                                        <igEditors:XamTextEditor Grid.Column="1" Text="{Binding Remarks}" 
                                                               Style="{StaticResource InputControlStyle}"
                                                               GotFocus="InputControl_GotFocus"/>
                                    </Grid>
                                </Grid>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- ツールバー -->
        <Border Grid.Row="4" Background="#FAFAFA" BorderBrush="#DDDDDD" BorderThickness="0,1,0,0" Padding="15">
            <Grid>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                    <Button Content="項目追加" Command="{Binding AddItemCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}"/>
                    <Button Content="削除" Command="{Binding DeleteSelectedItemsCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}"/>
                    <Button Content="複製" Command="{Binding DuplicateSelectedItemsCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}"/>

                    <Separator Width="1" Height="25" Margin="10,0"/>

                    <Button Content="コピー" Command="{Binding CopySelectedItemCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}"/>
                    <Button Content="貼り付け" Command="{Binding PasteItemCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}"/>

                    <Separator Width="1" Height="25" Margin="10,0"/>

                    <Button Content="↑" Command="{Binding MoveSelectedItemUpCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}" Width="30" ToolTip="選択項目を上に移動"/>
                    <Button Content="↓" Command="{Binding MoveSelectedItemDownCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}" Width="30" ToolTip="選択項目を下に移動"/>

                    <Separator Width="1" Height="25" Margin="10,0"/>

                    <Button Content="全選択/解除" Command="{Binding ToggleAllSelectionCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="バリデーション" Command="{Binding ValidateEstimateCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}"/>
                    <Button Content="印刷プレビュー" Command="{Binding PrintPreviewCommand}" 
                            Style="{StaticResource ToolbarButtonStyle}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- フッター：合計金額と保存ボタン -->
        <Border Grid.Row="5" Background="#1976D2" Padding="15">
            <Grid>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                    <TextBlock Text="{Binding TotalAmount, StringFormat='合計金額: {0:C}'}" 
                             FontSize="18" FontWeight="Bold" Foreground="White" 
                             VerticalAlignment="Center"/>
                    <TextBlock Text="|" FontSize="18" Foreground="White" Margin="15,0" 
                             VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding EstimateItems.Count, StringFormat='項目数: {0}件'}" 
                             FontSize="14" FontWeight="SemiBold" Foreground="White" 
                             VerticalAlignment="Center"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="新規作成" Command="{Binding ClearEstimateCommand}" 
                            Width="80" Height="35" Margin="0,0,10,0"
                            Background="White" Foreground="#1976D2" FontWeight="Bold"/>
                    <Button Content="見積保存" Command="{Binding SaveEstimateCommand}" 
                            Width="100" Height="35"
                            Background="White" Foreground="#1976D2" FontWeight="Bold"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>